import plugin.domain.Json
import plugin.domain.Map
import plugin.domain.Xml

import java.nio.charset.StandardCharsets

plugins {
	id 'java'
	id 'org.jetbrains.intellij' version '0.6.5'
}

group 'com.github.adamwojszczyk'
version '0.0.2'

repositories {
	mavenCentral()
}

intellij {
	version '2020.3'
}

patchPluginXml {
	untilBuild = '211.*'
	pluginDescription = """
    	Light eye-friendly theme
    	<br><br>
    	<a href="https://github.com/adamwojszczyk/sepia-theme">On GitHub</a> | <a href="https://github.com/adamwojszczyk/sepia-theme/issues">Report an issue</a>
    	<br><br><br>
    	<img src="https://raw.githubusercontent.com/adamwojszczyk/sepia-theme/master/screenshots/main-window.png" border="0" alt="Main window screenshot">
	"""
	changeNotes = """
		<i><b>0.0.2</b></i>
		<ul>
			<li>color diff & merge</li>
		</ul>
		<i><b>0.0.1</b></i>
		<ul>
			<li>initial release</li>
		</ul>
	"""
}

publishPlugin {
	channels 'stable'
	token = System.getenv('ORG_GRADLE_PROJECT_intellijPublishToken')
}

task generatePluginXml(type: Copy, group: "theme") {
	outputs.upToDateWhen { false }
	from "$projectDir/src/main/templates/"
	expand(new Map(new plugin.Plugin()).string())
	into "$projectDir/src/main/resources/"
}

task generateIntelliJTheme(group: "theme") {
	outputs.upToDateWhen { false }
	doLast {
		File file = file("$projectDir/src/main/resources/intellij.theme.json")
		file.setText(new Json(new plugin.Plugin().theme()).asString(), StandardCharsets.UTF_8.name())
	}
}

task generateIntelliJScheme(group: "theme") {
	outputs.upToDateWhen { false }
	doLast {
		File file = file("$projectDir/src/main/resources/intellij.scheme.xml")
		file.setText(new Xml(new plugin.Plugin().scheme()).asString(), StandardCharsets.UTF_8.name())
	}
}

task generateTheme(group: "theme") {
	dependsOn(generatePluginXml, generateIntelliJTheme, generateIntelliJScheme)
}

buildPlugin.dependsOn(generateTheme)
